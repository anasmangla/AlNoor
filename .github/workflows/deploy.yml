name: Deploy to Bluehost (SSH)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      deploy_path:
        description: "Remote folder (e.g., ~/public_html/alnoor)"
        required: false
      branch:
        description: "Git branch to deploy"
        default: "main"
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Write SSH private key
        run: |
          set -euo pipefail
          printf '%s\n' "${{ secrets.SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Deploy via SSH
        run: |
          set -euo pipefail
          ssh -i key.pem -oKexAlgorithms=+diffie-hellman-group-exchange-sha256 \
            -p "${{ secrets.SSH_PORT }}" \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" <<'EOF'
            set -euo pipefail

            # Resolve deploy path: dispatch input > repo variable > required
            DEPLOY_PATH="${{ github.event.inputs.deploy_path || vars.DEPLOY_PATH || '' }}"
            if [ -z "$DEPLOY_PATH" ]; then
              echo "DEPLOY_PATH not set. Provide it as a workflow input or set vars.DEPLOY_PATH."; exit 1
            fi

            BRANCH="${{ github.event.inputs.branch || 'main' }}"

            echo "Deploy path: $DEPLOY_PATH"
            echo "Branch: $BRANCH"

            mkdir -p "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"

            # Initialize or update Git working tree
            if [ ! -d .git ]; then
              git init
              git remote add origin "https://github.com/${{ github.repository }}.git"
              git fetch --depth=1 origin "$BRANCH"
              git checkout -f FETCH_HEAD
            else
              git fetch origin "$BRANCH"
              git reset --hard "origin/$BRANCH"
              git clean -fd
            fi

            # Frontend build (Next.js)
            if [ -d frontend ] && command -v npm >/dev/null 2>&1; then
              cd frontend
              (npm ci --omit=dev || npm install --production || true)
              (npm run build || true)
              cd ..
            fi

            # Backend deps (FastAPI)
            if [ -d backend ]; then
              cd backend
              if command -v pip3 >/dev/null 2>&1; then
                (pip3 install -r requirements.txt || true)
              fi
              # Trigger Passenger restart if present
              mkdir -p tmp && touch tmp/restart.txt || true
              cd ..
            fi
          EOF

      - name: Clean up SSH key
        if: always()
        run: |
          set -euo pipefail
          rm -f key.pem

